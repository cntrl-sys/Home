<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>version 1.6</title>
<style>
body{
margin:0;
background:#111;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
color:white;
font-family:Arial;
}
canvas{
border:2px solid #444;
}
</style>
</head>
<body>

<canvas id="game" width="900" height="500"></canvas>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

let state="menu";
let level=0;

const themes=[
{bg:"#2f6b2f",path:"#c2a36b"},
{bg:"#d6b26a",path:"#8b5a2b"},
{bg:"#3b0b0b",path:"#ff6b00"}
];

const paths=[
[
{x:0,y:250},{x:250,y:250},{x:250,y:100},{x:650,y:100},{x:650,y:400},{x:900,y:400}
],
[
{x:0,y:150},{x:300,y:150},{x:300,y:350},{x:700,y:350},{x:700,y:200},{x:900,y:200}
],
[
{x:0,y:400},{x:350,y:400},{x:350,y:150},{x:900,y:150}
]
];

let path=[];
let enemies=[],towers=[],shots=[],explosions=[];
let money,lives,wave,spawnTimer;
let currentTower="normal";

// ---------- ENEMY ----------
class Enemy{
constructor(type="normal",boss=false){
this.type=type;
this.x=path[0].x;
this.y=path[0].y;
this.i=0;

this.burn=0;
this.slow=1;

if(type=="fly"){
this.hp=80+wave*15;
this.speed=1.8;
this.size=14;
this.reward=15;
}
else if(boss){
this.hp=700+wave*200;
this.speed=0.6;
this.size=28;
this.reward=150;
}
else{
this.hp=130+wave*25;
this.speed=1+wave*0.05;
this.size=18;
this.reward=10;
}
}

move(){
let t=path[this.i+1];
if(!t)return;

let dx=t.x-this.x;
let dy=t.y-this.y;
let d=Math.hypot(dx,dy);

let sp=this.speed*this.slow;

if(d<sp)this.i++;
else{
this.x+=dx/d*sp;
this.y+=dy/d*sp;
}

if(this.burn>0){
this.hp-=0.5;
this.burn--;
}
}

draw(){
if(this.type=="fly")ctx.fillStyle="yellow";
else ctx.fillStyle="red";

ctx.beginPath();
ctx.arc(this.x,this.y,this.size/2,0,Math.PI*2);
ctx.fill();

ctx.fillStyle="green";
ctx.fillRect(this.x-15,this.y-18,30*(this.hp/900),4);
}
}

// ---------- TOWER ----------
class Tower{
constructor(x,y,type){
this.x=x;
this.y=y;
this.type=type;
this.level=1;
this.cool=0;

if(type=="fire"){
this.range=90;
this.damage=18;
this.coolMax=20;
}
else if(type=="ice"){
this.range=110;
this.damage=10;
this.coolMax=30;
}
else if(type=="sniper"){
this.range=240;
this.damage=70;
this.coolMax=90;
}
else{
this.range=120;
this.damage=25;
this.coolMax=25;
}
}

shoot(){
if(this.cool>0){this.cool--;return;}

for(let e of enemies){

if(e.type=="fly" && this.type!="sniper")continue;

let d=Math.hypot(e.x-this.x,e.y-this.y);

if(d<this.range){
e.hp-=this.damage;

if(this.type=="fire") e.burn=80;
if(this.type=="ice") e.slow=0.4;

shots.push({x:this.x,y:this.y,tx:e.x,ty:e.y});
this.cool=this.coolMax;
break;
}
}
}

upgrade(){
if(money>=60){
money-=60;
this.level++;
this.damage+=10;
this.range+=10;
}
}

draw(){
if(this.type=="fire")ctx.fillStyle="orange";
else if(this.type=="ice")ctx.fillStyle="cyan";
else if(this.type=="sniper")ctx.fillStyle="purple";
else ctx.fillStyle="blue";

ctx.beginPath();
ctx.arc(this.x,this.y,14,0,Math.PI*2);
ctx.fill();

ctx.fillStyle="white";
ctx.font="12px Arial";
ctx.fillText("L"+this.level,this.x-8,this.y+4);
}
}

// ---------- EXPLOSION ----------
function makeExplosion(x,y){
explosions.push({x,y,r:5,life:20});

for(let e of enemies){
let d=Math.hypot(e.x-x,e.y-y);
if(d<80){
e.hp-=80*(1-d/80);
}
}
}

// ---------- SPAWN ----------
function spawnWave(){
spawnTimer++;

if(spawnTimer%45===0){
if(Math.random()<0.25) enemies.push(new Enemy("fly"));
else enemies.push(new Enemy());
}

if(spawnTimer>350){
enemies.push(new Enemy("normal",true));
spawnTimer=0;
wave++;
}
}

// ---------- CONTROLS ----------
canvas.addEventListener("click",e=>{
if(state=="menu"){
if(e.offsetY>180 && e.offsetY<230)startGame(0);
if(e.offsetY>240 && e.offsetY<290)startGame(1);
if(e.offsetY>300 && e.offsetY<350)startGame(2);
return;
}

for(let t of towers){
if(Math.hypot(t.x-e.offsetX,t.y-e.offsetY)<14){
t.upgrade();
return;
}
}

if(money>=50){
towers.push(new Tower(e.offsetX,e.offsetY,currentTower));
money-=50;
}
});

canvas.addEventListener("contextmenu",e=>{
e.preventDefault();
makeExplosion(e.offsetX,e.offsetY);
});

document.addEventListener("keydown",e=>{
if(e.key=="1")currentTower="normal";
if(e.key=="2")currentTower="fire";
if(e.key=="3")currentTower="ice";
if(e.key=="4")currentTower="sniper";
});

// ---------- START ----------
function startGame(lv){
state="game";
level=lv;
path=paths[lv];
money=200;
lives=10;
wave=1;
spawnTimer=0;
enemies=[];
towers=[];
explosions=[];
}

// ---------- DRAW ----------
function drawMenu(){
ctx.fillStyle="white";
ctx.font="40px Arial";
ctx.fillText("Tower Defense PRO",250,120);
ctx.font="24px Arial";
ctx.fillText("Level 1 Grass",350,210);
ctx.fillText("Level 2 Desert",350,270);
ctx.fillText("Level 3 Lava",350,330);
}

function drawPath(){
ctx.strokeStyle=themes[level].path;
ctx.lineWidth=18;
ctx.beginPath();
ctx.moveTo(path[0].x,path[0].y);
for(let i=1;i<path.length;i++)ctx.lineTo(path[i].x,path[i].y);
ctx.stroke();
}

// ---------- LOOP ----------
function loop(){
ctx.fillStyle=themes[level]?.bg||"#222";
ctx.fillRect(0,0,900,500);

if(state=="menu"){
drawMenu();
requestAnimationFrame(loop);
return;
}

drawPath();
spawnWave();

for(let i=enemies.length-1;i>=0;i--){
let e=enemies[i];
e.move();
e.draw();

if(e.i>=path.length-1){
lives--;
enemies.splice(i,1);
}
else if(e.hp<=0){
money+=e.reward;
enemies.splice(i,1);
}
}

for(let t of towers){
t.shoot();
t.draw();
}

for(let i=shots.length-1;i>=0;i--){
let s=shots[i];
ctx.strokeStyle="white";
ctx.beginPath();
ctx.moveTo(s.x,s.y);
ctx.lineTo(s.tx,s.ty);
ctx.stroke();
shots.splice(i,1);
}

for(let i=explosions.length-1;i>=0;i--){
let ex=explosions[i];
ctx.fillStyle="rgba(255,140,0,0.5)";
ctx.beginPath();
ctx.arc(ex.x,ex.y,ex.r,0,Math.PI*2);
ctx.fill();
ex.r+=4;
ex.life--;
if(ex.life<=0)explosions.splice(i,1);
}

ctx.fillStyle="white";
ctx.font="16px Arial";
ctx.fillText("Geld: "+money,10,20);
ctx.fillText("Leben: "+lives,10,40);
ctx.fillText("Welle: "+wave,10,60);
ctx.fillText("Tower: 1 Normal 2 Fire 3 Ice 4 Sniper",10,90);
ctx.fillText("Rechtsklick = Explosion",10,110);

if(lives<=0){
ctx.fillStyle="red";
ctx.font="40px Arial";
ctx.fillText("GAME OVER",340,260);
}

requestAnimationFrame(loop);
}

loop();
</script>

</body>
</html>
