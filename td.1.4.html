<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>version 1.4</title>
<style>
body{
margin:0;
background:#111;
color:white;
font-family:Arial;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
}
canvas{
background:#222;
border:2px solid #555;
}
</style>
</head>
<body>

<canvas id="game" width="800" height="450"></canvas>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

let state="menu";
let level=1;

const gridSize=50;
const cols=16;
const rows=9;

let grid=[];
let towers=[];
let enemies=[];
let shots=[];
let explosions=[];

let money=200;
let lives=10;
let wave=1;
let spawnTimer=0;

// Level Pfade
const levels=[
[
{x:0,y:100},{x:300,y:100},{x:300,y:300},{x:800,y:300}
],
[
{x:0,y:200},{x:200,y:200},{x:200,y:80},{x:600,y:80},{x:600,y:350},{x:800,y:350}
]
];

let path=levels[0];

// Grid erstellen
function createGrid(){
grid=[];
for(let y=0;y<rows;y++){
let row=[];
for(let x=0;x<cols;x++){
row.push({tower:null});
}
grid.push(row);
}
}

// Gegner
class Enemy{
constructor(){
this.x=path[0].x;
this.y=path[0].y;
this.i=0;
this.hp=100+wave*20;
this.speed=1+wave*0.1;
}

move(){
let t=path[this.i+1];
if(!t)return;
let dx=t.x-this.x;
let dy=t.y-this.y;
let d=Math.hypot(dx,dy);
if(d<this.speed)this.i++;
else{
this.x+=dx/d*this.speed;
this.y+=dy/d*this.speed;
}
}

draw(){
ctx.fillStyle="red";
ctx.fillRect(this.x-10,this.y-10,20,20);

ctx.fillStyle="green";
ctx.fillRect(this.x-10,this.y-15,20*(this.hp/300),3);
}
}

// Tower
class Tower{
constructor(cx,cy){
this.cx=cx;
this.cy=cy;
this.x=cx*gridSize+25;
this.y=cy*gridSize+25;
this.range=120;
this.damage=25;
this.cool=0;
this.level=1;
}

shoot(){
if(this.cool>0){this.cool--;return;}
for(let e of enemies){
let d=Math.hypot(e.x-this.x,e.y-this.y);
if(d<this.range){
e.hp-=this.damage;
shots.push({x:this.x,y:this.y,tx:e.x,ty:e.y});
this.cool=30;
break;
}
}
}

upgrade(){
if(money>=50){
money-=50;
this.level++;
this.damage+=10;
this.range+=10;
}
}

draw(){
ctx.fillStyle="blue";
ctx.beginPath();
ctx.arc(this.x,this.y,15,0,Math.PI*2);
ctx.fill();

ctx.fillStyle="white";
ctx.fillText("L"+this.level,this.x-8,this.y+5);
}
}

// Explosion
function createExplosion(x,y){
explosions.push({x,y,r:5,life:20});
for(let e of enemies){
if(Math.hypot(e.x-x,e.y-y)<60){
e.hp-=40;
}
}
}

// Spawning
function spawnWave(){
spawnTimer++;
if(spawnTimer%50==0){
enemies.push(new Enemy());
}
if(spawnTimer>350){
spawnTimer=0;
wave++;
}
}

// Klick
canvas.addEventListener("click",e=>{
let x=Math.floor(e.offsetX/gridSize);
let y=Math.floor(e.offsetY/gridSize);

if(state=="menu"){
if(e.offsetY>180 && e.offsetY<230){startGame(0);}
if(e.offsetY>250 && e.offsetY<300){startGame(1);}
return;
}

let cell=grid[y]?.[x];
if(!cell)return;

if(cell.tower){
cell.tower.upgrade();
}
else if(money>=50){
let t=new Tower(x,y);
cell.tower=t;
towers.push(t);
money-=50;
}
});

// Rechtsklick Explosion
canvas.addEventListener("contextmenu",e=>{
e.preventDefault();
createExplosion(e.offsetX,e.offsetY);
});

// Start Level
function startGame(lv){
level=lv+1;
path=levels[lv];
state="game";
money=200;
lives=10;
wave=1;
enemies=[];
towers=[];
createGrid();
}

// Zeichnen Grid
function drawGrid(){
ctx.strokeStyle="#333";
for(let x=0;x<cols;x++){
for(let y=0;y<rows;y++){
ctx.strokeRect(x*gridSize,y*gridSize,gridSize,gridSize);
}
}
}

// MenÃ¼
function drawMenu(){
ctx.clearRect(0,0,800,450);
ctx.fillStyle="white";
ctx.font="40px Arial";
ctx.fillText("Tower Defense",240,120);

ctx.font="25px Arial";
ctx.fillText("Level 1",350,220);
ctx.fillText("Level 2",350,290);
}

// Game Loop
function loop(){
ctx.clearRect(0,0,800,450);

if(state=="menu"){
drawMenu();
requestAnimationFrame(loop);
return;
}

drawGrid();

// Pfad
ctx.strokeStyle="yellow";
ctx.lineWidth=18;
ctx.beginPath();
ctx.moveTo(path[0].x,path[0].y);
for(let i=1;i<path.length;i++)ctx.lineTo(path[i].x,path[i].y);
ctx.stroke();

spawnWave();

for(let i=enemies.length-1;i>=0;i--){
let e=enemies[i];
e.move();
e.draw();
if(e.i>=path.length-1){lives--;enemies.splice(i,1);}
else if(e.hp<=0){money+=10;enemies.splice(i,1);}
}

for(let t of towers){
t.shoot();
t.draw();
}

for(let i=shots.length-1;i>=0;i--){
let s=shots[i];
ctx.strokeStyle="white";
ctx.beginPath();
ctx.moveTo(s.x,s.y);
ctx.lineTo(s.tx,s.ty);
ctx.stroke();
shots.splice(i,1);
}

for(let i=explosions.length-1;i>=0;i--){
let ex=explosions[i];
ctx.fillStyle="rgba(255,150,0,0.5)";
ctx.beginPath();
ctx.arc(ex.x,ex.y,ex.r,0,Math.PI*2);
ctx.fill();
ex.r+=3;
ex.life--;
if(ex.life<=0)explosions.splice(i,1);
}

// HUD
ctx.fillStyle="white";
ctx.fillText("Geld:"+money,10,20);
ctx.fillText("Leben:"+lives,10,40);
ctx.fillText("Welle:"+wave,10,60);
ctx.fillText("Rechtsklick = Explosion",10,80);

if(lives<=0){
ctx.fillStyle="red";
ctx.font="40px Arial";
ctx.fillText("GAME OVER",300,220);
}

requestAnimationFrame(loop);
}

createGrid();
loop();
</script>

</body>
</html>
