<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tower Defense Pro+</title>
<style>
body{
margin:0;
background:#111;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
font-family:Arial;
color:white;
}
canvas{
border:2px solid #444;
}
</style>
</head>
<body>

<canvas id="game" width="900" height="500"></canvas>

<script>
const c=document.getElementById("game");
const ctx=c.getContext("2d");

let state="menu";
let level=0;

const themes=[
{bg:"#2f6b2f",path:"#c2a36b"},
{bg:"#d6b26a",path:"#8b5a2b"},
{bg:"#3b0b0b",path:"#ff6b00"}
];

const paths=[
[{x:0,y:250},{x:250,y:250},{x:250,y:100},{x:650,y:100},{x:650,y:400},{x:900,y:400}],
[{x:0,y:150},{x:300,y:150},{x:300,y:350},{x:700,y:350},{x:900,y:200}],
[{x:0,y:400},{x:350,y:400},{x:350,y:150},{x:900,y:150}]
];

let path=[];
let enemies=[],towers=[],shots=[],explosions=[];
let money,lives,wave,spawnTimer;

let currentTower="normal";

let skills={
damage:0,
range:0,
fire:0
};

// -------- ENEMY --------
class Enemy{
constructor(type="normal",boss=false){
this.type=type;
this.x=path[0].x;
this.y=path[0].y;
this.i=0;

this.maxHp=boss?900+wave*200:(type=="fly"?120:160)+wave*20;
this.hp=this.maxHp;

this.speed=boss?0.7:(type=="fly"?2:1+wave*0.05);
this.size=boss?30:(type=="fly"?14:18);
this.reward=boss?180:(type=="fly"?18:10);

this.burn=0;
this.slow=1;

this.boss=boss;
this.skillTimer=0;
}

move(){
let t=path[this.i+1];
if(!t)return;

let dx=t.x-this.x;
let dy=t.y-this.y;
let d=Math.hypot(dx,dy);

let sp=this.speed*this.slow;

if(d<sp)this.i++;
else{
this.x+=dx/d*sp;
this.y+=dy/d*sp;
}

if(this.burn>0){
this.hp-=0.6;
this.burn--;
}

if(this.boss){
this.skillTimer++;
if(this.skillTimer%200===0){
this.speed+=0.4;
}
if(this.skillTimer%300===0){
this.hp+=80;
if(this.hp>this.maxHp)this.hp=this.maxHp;
}
}
}

draw(){
ctx.fillStyle=this.type=="fly"?"yellow":(this.boss?"black":"red");
ctx.beginPath();
ctx.arc(this.x,this.y,this.size/2,0,Math.PI*2);
ctx.fill();

let w=30;
let h=5;
let pct=this.hp/this.maxHp;

ctx.fillStyle="#222";
ctx.fillRect(this.x-w/2,this.y-20,w,h);

ctx.fillStyle="lime";
ctx.fillRect(this.x-w/2,this.y-20,w*pct,h);

ctx.strokeStyle="white";
ctx.strokeRect(this.x-w/2,this.y-20,w,h);
}
}

// -------- TOWER --------
class Tower{
constructor(x,y,type){
this.x=x;
this.y=y;
this.type=type;
this.angle=0;
this.cool=0;
this.level=1;

this.range=120+skills.range*10;
this.damage=25+skills.damage*5;
this.coolMax=25;

if(type=="fire"){this.range=90;this.damage=18;this.coolMax=20;}
if(type=="ice"){this.range=110;this.damage=10;this.coolMax=30;}
if(type=="sniper"){this.range=240;this.damage=70;this.coolMax=90;}
}

shoot(){
if(this.cool>0){this.cool--;return;}

let target=null;
let dist=9999;

for(let e of enemies){
if(e.type=="fly" && this.type!="sniper")continue;

let d=Math.hypot(e.x-this.x,e.y-this.y);
if(d<this.range && d<dist){
dist=d;
target=e;
}
}

if(target){
this.angle=Math.atan2(target.y-this.y,target.x-this.x);

target.hp-=this.damage;

if(this.type=="fire"){
target.burn=80+skills.fire*20;
}
if(this.type=="ice"){
target.slow=0.4;
}

shots.push({x:this.x,y:this.y,tx:target.x,ty:target.y});
this.cool=this.coolMax;
}
}

upgrade(){
if(money>=70){
money-=70;
this.level++;
this.damage+=12;
this.range+=10;
}
}

draw(){
ctx.save();
ctx.translate(this.x,this.y);
ctx.rotate(this.angle);

ctx.fillStyle=
this.type=="fire"?"orange":
this.type=="ice"?"cyan":
this.type=="sniper"?"purple":"blue";

ctx.fillRect(-12,-6,24,12);

ctx.restore();

ctx.fillStyle="white";
ctx.font="12px Arial";
ctx.fillText("L"+this.level,this.x-8,this.y+20);
}
}

// -------- EXPLOSION --------
function explode(x,y){
explosions.push({x,y,r:5,life:18});

for(let e of enemies){
let d=Math.hypot(e.x-x,e.y-y);
if(d<80){
e.hp-=90*(1-d/80);
}
}
}

// -------- SPAWN --------
function spawnWave(){
spawnTimer++;

if(spawnTimer%45===0){
if(Math.random()<0.25)enemies.push(new Enemy("fly"));
else enemies.push(new Enemy());
}

if(spawnTimer>360){
enemies.push(new Enemy("normal",true));
spawnTimer=0;
wave++;
}
}

// -------- INPUT --------
c.addEventListener("click",e=>{
if(state=="menu"){
if(e.offsetY>180&&e.offsetY<230)start(0);
if(e.offsetY>240&&e.offsetY<290)start(1);
if(e.offsetY>300&&e.offsetY<350)start(2);
return;
}

for(let t of towers){
if(Math.hypot(t.x-e.offsetX,t.y-e.offsetY)<15){
t.upgrade();
return;
}
}

if(money>=50){
towers.push(new Tower(e.offsetX,e.offsetY,currentTower));
money-=50;
}
});

c.addEventListener("contextmenu",e=>{
e.preventDefault();
explode(e.offsetX,e.offsetY);
});

document.addEventListener("keydown",e=>{
if(e.key=="1")currentTower="normal";
if(e.key=="2")currentTower="fire";
if(e.key=="3")currentTower="ice";
if(e.key=="4")currentTower="sniper";

if(e.key=="q"&&money>=100){skills.damage++;money-=100;}
if(e.key=="w"&&money>=100){skills.range++;money-=100;}
if(e.key=="e"&&money>=100){skills.fire++;money-=100;}
});

// -------- START --------
function start(lv){
state="game";
level=lv;
path=paths[lv];
money=250;
lives=10;
wave=1;
spawnTimer=0;
enemies=[];
towers=[];
}

// -------- DRAW --------
function drawPath(){
ctx.strokeStyle=themes[level].path;
ctx.lineWidth=18;
ctx.beginPath();
ctx.moveTo(path[0].x,path[0].y);
for(let i=1;i<path.length;i++)ctx.lineTo(path[i].x,path[i].y);
ctx.stroke();
}

function drawMenu(){
ctx.fillStyle="white";
ctx.font="40px Arial";
ctx.fillText("Tower Defense PRO+",230,120);
ctx.font="24px Arial";
ctx.fillText("Level 1 Grass",360,210);
ctx.fillText("Level 2 Desert",360,270);
ctx.fillText("Level 3 Lava",360,330);
}

// -------- LOOP --------
function loop(){
ctx.fillStyle=themes[level]?.bg||"#222";
ctx.fillRect(0,0,900,500);

if(state=="menu"){
drawMenu();
requestAnimationFrame(loop);
return;
}

drawPath();
spawnWave();

for(let i=enemies.length-1;i>=0;i--){
let e=enemies[i];
e.move();
e.draw();

if(e.i>=path.length-1){
lives--;
enemies.splice(i,1);
}
else if(e.hp<=0){
money+=e.reward;
enemies.splice(i,1);
}
}

for(let t of towers){
t.shoot();
t.draw();
}

for(let i=shots.length-1;i>=0;i--){
let s=shots[i];
ctx.strokeStyle="white";
ctx.beginPath();
ctx.moveTo(s.x,s.y);
ctx.lineTo(s.tx,s.ty);
ctx.stroke();
shots.splice(i,1);
}

for(let i=explosions.length-1;i>=0;i--){
let ex=explosions[i];
ctx.fillStyle="rgba(255,140,0,0.5)";
ctx.beginPath();
ctx.arc(ex.x,ex.y,ex.r,0,Math.PI*2);
ctx.fill();
ex.r+=4;
ex.life--;
if(ex.life<=0)explosions.splice(i,1);
}

ctx.fillStyle="white";
ctx.font="16px Arial";
ctx.fillText("Geld: "+money,10,20);
ctx.fillText("Leben: "+lives,10,40);
ctx.fillText("Welle: "+wave,10,60);

ctx.fillText("1 Normal 2 Fire 3 Ice 4 Sniper",10,90);
ctx.fillText("Skilltree: Q Damage  W Range  E Fire",10,115);

ctx.fillText("DMG:"+skills.damage+" RNG:"+skills.range+" FIRE:"+skills.fire,10,140);

if(lives<=0){
ctx.fillStyle="red";
ctx.font="40px Arial";
ctx.fillText("GAME OVER",340,260);
}

requestAnimationFrame(loop);
}

loop();
</script>

</body>
</html>
