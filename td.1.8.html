<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tower Defense Ultimate</title>
<style>
body{
margin:0;
background:#111;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
color:white;
font-family:Arial;
}
canvas{
border:2px solid #444;
}
</style>
</head>
<body>

<canvas id="game" width="900" height="500"></canvas>

<script>
const c=document.getElementById("game");
const ctx=c.getContext("2d");

let state="world";
let level=0;

const themes=["#2f6b2f","#d6b26a","#3b0b0b"];

const paths=[
[{x:0,y:250},{x:300,y:250},{x:300,y:120},{x:700,y:120},{x:900,y:350}],
[{x:0,y:150},{x:350,y:150},{x:350,y:350},{x:900,y:350}],
[{x:0,y:400},{x:350,y:400},{x:350,y:150},{x:900,y:150}]
];

let path=[];
let enemies=[],towers=[],bullets=[],particles=[],bossShots=[];

let money=300,lives=10,wave=1,spawn=0;

let shopBonus={damage:0,range:0,rate:0};

let towerType="normal";

class Particle{
constructor(x,y){
this.x=x;this.y=y;
this.vx=(Math.random()-0.5)*3;
this.vy=(Math.random()-0.5)*3;
this.life=20;
}
move(){
this.x+=this.vx;
this.y+=this.vy;
this.life--;
}
draw(){
ctx.fillStyle="orange";
ctx.fillRect(this.x,this.y,3,3);
}
}

class Enemy{
constructor(boss=false){
this.x=path[0].x;
this.y=path[0].y;
this.i=0;
this.boss=boss;

this.maxHp=boss?1200+wave*300:160+wave*25;
this.hp=this.maxHp;

this.speed=boss?0.6:1+wave*0.05;
this.size=boss?30:18;
this.cool=0;
}

move(){
let t=path[this.i+1];
if(!t)return;

let dx=t.x-this.x;
let dy=t.y-this.y;
let d=Math.hypot(dx,dy);

if(d<this.speed)this.i++;
else{
this.x+=dx/d*this.speed;
this.y+=dy/d*this.speed;
}

if(this.boss){
this.cool++;
if(this.cool>120){
this.cool=0;
bossShots.push({x:this.x,y:this.y});
}
}
}

draw(){
ctx.fillStyle=this.boss?"black":"red";
ctx.beginPath();
ctx.arc(this.x,this.y,this.size/2,0,Math.PI*2);
ctx.fill();

let w=32;
let p=this.hp/this.maxHp;

ctx.fillStyle="#222";
ctx.fillRect(this.x-w/2,this.y-22,w,5);

ctx.fillStyle="lime";
ctx.fillRect(this.x-w/2,this.y-22,w*p,5);

ctx.strokeStyle="white";
ctx.strokeRect(this.x-w/2,this.y-22,w,5);
}
}

class Tower{
constructor(x,y){
this.x=x;this.y=y;
this.angle=0;
this.cool=0;

this.range=130+shopBonus.range*15;
this.damage=28+shopBonus.damage*6;
this.rate=22-shopBonus.rate*2;
if(this.rate<6)this.rate=6;
}

shoot(){
if(this.cool>0){this.cool--;return;}

let target=null;
let dist=9999;

for(let e of enemies){
let d=Math.hypot(e.x-this.x,e.y-this.y);
if(d<this.range&&d<dist){
dist=d;
target=e;
}
}

if(target){
this.angle=Math.atan2(target.y-this.y,target.x-this.x);
bullets.push({
x:this.x,
y:this.y,
tx:target
});
this.cool=this.rate;
}
}

draw(){
ctx.save();
ctx.translate(this.x,this.y);
ctx.rotate(this.angle);
ctx.fillStyle="blue";
ctx.fillRect(-14,-5,28,10);
ctx.restore();
}
}

class Bullet{
constructor(x,y,target){
this.x=x;this.y=y;
this.target=target;
this.speed=6;
}

move(){
let dx=this.target.x-this.x;
let dy=this.target.y-this.y;
let d=Math.hypot(dx,dy);

if(d<6){
this.target.hp-=25;
for(let i=0;i<6;i++)particles.push(new Particle(this.x,this.y));
return true;
}

this.x+=dx/d*this.speed;
this.y+=dy/d*this.speed;
return false;
}

draw(){
ctx.fillStyle="white";
ctx.fillRect(this.x,this.y,4,4);
}
}

function spawnEnemies(){
spawn++;

if(spawn%40==0){
enemies.push(new Enemy());
}

if(spawn>350){
enemies.push(new Enemy(true));
spawn=0;
wave++;
}
}

c.addEventListener("click",e=>{
if(state=="world"){
if(e.offsetX<300)startLevel(0);
else if(e.offsetX<600)startLevel(1);
else startLevel(2);
return;
}

if(state=="shop"){
if(e.offsetY<170&&money>=100){shopBonus.damage++;money-=100;}
if(e.offsetY>170&&e.offsetY<260&&money>=100){shopBonus.range++;money-=100;}
if(e.offsetY>260&&money>=100){shopBonus.rate++;money-=100;}
if(e.offsetX>650)state="game";
return;
}

for(let t of towers){
if(Math.hypot(t.x-e.offsetX,t.y-e.offsetY)<14)return;
}

if(money>=50){
towers.push(new Tower(e.offsetX,e.offsetY));
money-=50;
}
});

function startLevel(lv){
level=lv;
path=paths[lv];
state="game";
money+=100;
enemies=[];
towers=[];
bullets=[];
particles=[];
bossShots=[];
wave=1;
spawn=0;
}

function drawWorld(){
ctx.fillStyle="#222";
ctx.fillRect(0,0,900,500);
ctx.fillStyle="white";
ctx.font="30px Arial";
ctx.fillText("WORLD MAP",350,80);
ctx.fillText("üåø",140,260);
ctx.fillText("üèú",440,260);
ctx.fillText("üåã",740,260);
ctx.font="18px Arial";
ctx.fillText("Click a world",370,430);
}

function drawShop(){
ctx.fillStyle="#222";
ctx.fillRect(0,0,900,500);

ctx.fillStyle="white";
ctx.font="30px Arial";
ctx.fillText("SHOP",400,80);

ctx.font="20px Arial";
ctx.fillText("Damage + (100)",300,160);
ctx.fillText("Range + (100)",300,230);
ctx.fillText("Fire Rate + (100)",300,300);

ctx.fillText("Click right to continue ‚ñ∂",620,450);
ctx.fillText("Money: "+money,20,30);
}

function loop(){
ctx.fillStyle=themes[level]||"#222";
ctx.fillRect(0,0,900,500);

if(state=="world"){
drawWorld();
requestAnimationFrame(loop);
return;
}

if(state=="shop"){
drawShop();
requestAnimationFrame(loop);
return;
}

spawnEnemies();

ctx.strokeStyle="#c2a36b";
ctx.lineWidth=18;
ctx.beginPath();
ctx.moveTo(path[0].x,path[0].y);
for(let i=1;i<path.length;i++)ctx.lineTo(path[i].x,path[i].y);
ctx.stroke();

for(let i=enemies.length-1;i>=0;i--){
let e=enemies[i];
e.move();
e.draw();

if(e.i>=path.length-1){
lives--;
enemies.splice(i,1);
}
else if(e.hp<=0){
money+=e.boss?200:12;
enemies.splice(i,1);
}
}

for(let t of towers){
t.shoot();
t.draw();
}

for(let i=bullets.length-1;i>=0;i--){
let b=bullets[i];
if(b.move())bullets.splice(i,1);
else b.draw();
}

for(let i=particles.length-1;i>=0;i--){
let p=particles[i];
p.move();
p.draw();
if(p.life<=0)particles.splice(i,1);
}

ctx.fillStyle="white";
ctx.font="16px Arial";
ctx.fillText("Money: "+money,10,20);
ctx.fillText("Lives: "+lives,10,40);
ctx.fillText("Wave: "+wave,10,60);

if(lives<=0){
state="shop";
lives=10;
}
requestAnimationFrame(loop);
}

loop();
</script>

</body>
</html>
