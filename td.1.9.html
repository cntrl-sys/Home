<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tower Defense Ultimate</title>
<style>
body{
margin:0;
background:#111;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
font-family:Arial;
color:white;
}
canvas{border:2px solid #444;}
</style>
</head>
<body>

<canvas id="game" width="900" height="500"></canvas>

<script>
const c=document.getElementById("game");
const ctx=c.getContext("2d");

let state="world";
let level=0;

const themes=[
{bg:"#2f6b2f",path:"#c2a36b"},
{bg:"#d6b26a",path:"#8b5a2b"},
{bg:"#3b0b0b",path:"#ff6b00"}
];

const paths=[
[{x:0,y:250},{x:250,y:250},{x:250,y:100},{x:650,y:100},{x:650,y:400},{x:900,y:400}],
[{x:0,y:150},{x:300,y:150},{x:300,y:350},{x:700,y:350},{x:900,y:200}],
[{x:0,y:400},{x:350,y:400},{x:350,y:150},{x:900,y:150}]
];

let path=[];
let enemies=[],towers=[],projectiles=[],particles=[];
let money=300,lives=10,wave=1,spawnTimer=0;

let currentTower="normal";

// permanente Shop-Upgrades
let shop={
damage:0,
range:0,
income:0
};

// ---------- ENEMY ----------
class Enemy{
constructor(boss=false){
this.x=path[0].x;
this.y=path[0].y;
this.i=0;

this.boss=boss;
this.maxHp=boss?1200:180+wave*30;
this.hp=this.maxHp;
this.speed=boss?0.6:1+wave*0.05;
this.size=boss?30:18;
this.attackTimer=0;
}

move(){
let t=path[this.i+1];
if(!t)return;

let dx=t.x-this.x;
let dy=t.y-this.y;
let d=Math.hypot(dx,dy);

if(d<this.speed)this.i++;
else{
this.x+=dx/d*this.speed;
this.y+=dy/d*this.speed;
}

if(this.boss){
this.attackTimer++;
if(this.attackTimer>180){
this.attack();
this.attackTimer=0;
}
}
}

attack(){
for(let t of towers){
let d=Math.hypot(t.x-this.x,t.y-this.y);
if(d<120){
t.hp-=20;
}
}
}

draw(){
ctx.fillStyle=this.boss?"black":"red";
ctx.beginPath();
ctx.arc(this.x,this.y,this.size/2,0,Math.PI*2);
ctx.fill();

ctx.fillStyle="#222";
ctx.fillRect(this.x-20,this.y-22,40,5);
ctx.fillStyle="lime";
ctx.fillRect(this.x-20,this.y-22,40*(this.hp/this.maxHp),5);
ctx.strokeStyle="white";
ctx.strokeRect(this.x-20,this.y-22,40,5);
}
}

// ---------- TOWER ----------
class Tower{
constructor(x,y){
this.x=x;
this.y=y;
this.range=120+shop.range*15;
this.damage=25+shop.damage*6;
this.cool=0;
this.hp=100;
}

shoot(){
if(this.cool>0){this.cool--;return;}

let target=null;
let dist=9999;
for(let e of enemies){
let d=Math.hypot(e.x-this.x,e.y-this.y);
if(d<this.range && d<dist){
dist=d;
target=e;
}
}
if(target){
projectiles.push(new Projectile(this,target));
this.cool=25;
}
}

draw(){
ctx.fillStyle="blue";
ctx.beginPath();
ctx.arc(this.x,this.y,14,0,Math.PI*2);
ctx.fill();

ctx.fillStyle="green";
ctx.fillRect(this.x-15,this.y+18,30*(this.hp/100),4);
}
}

// ---------- PROJECTILE ----------
class Projectile{
constructor(tower,target){
this.x=tower.x;
this.y=tower.y;
this.tx=target.x;
this.ty=target.y;
this.target=target;
this.speed=6;
}

move(){
let dx=this.tx-this.x;
let dy=this.ty-this.y;
let d=Math.hypot(dx,dy);

if(d<6){
this.target.hp-=25;
makeParticles(this.x,this.y,"orange");
return true;
}
this.x+=dx/d*this.speed;
this.y+=dy/d*this.speed;
return false;
}

draw(){
ctx.fillStyle="yellow";
ctx.beginPath();
ctx.arc(this.x,this.y,4,0,Math.PI*2);
ctx.fill();
}
}

// ---------- PARTICLES ----------
function makeParticles(x,y,color){
for(let i=0;i<10;i++){
particles.push({
x,y,
vx:(Math.random()-0.5)*4,
vy:(Math.random()-0.5)*4,
life:20,
color
});
}
}

// ---------- SPAWN ----------
function spawn(){
spawnTimer++;
if(spawnTimer%40===0)enemies.push(new Enemy());
if(spawnTimer>300){
enemies.push(new Enemy(true));
spawnTimer=0;
wave++;
}
}

// ---------- INPUT ----------
c.addEventListener("click",e=>{
if(state==="world"){
if(e.offsetX>200&&e.offsetX<350)start(0);
if(e.offsetX>400&&e.offsetX<550)start(1);
if(e.offsetX>600&&e.offsetX<750)start(2);
return;
}

if(state==="shop"){
if(e.offsetY<200&&money>=150){shop.damage++;money-=150;}
if(e.offsetY>200&&e.offsetY<300&&money>=150){shop.range++;money-=150;}
if(e.offsetY>300&&money>=150){shop.income++;money-=150;}
if(e.offsetX>700)state="world";
return;
}

for(let t of towers){
if(Math.hypot(t.x-e.offsetX,t.y-e.offsetY)<14)return;
}

if(money>=50){
towers.push(new Tower(e.offsetX,e.offsetY));
money-=50;
}
});

// ---------- START ----------
function start(lv){
state="game";
level=lv;
path=paths[lv];
enemies=[];
towers=[];
projectiles=[];
particles=[];
wave=1;
spawnTimer=0;
}

// ---------- DRAW ----------
function drawPath(){
ctx.strokeStyle=themes[level].path;
ctx.lineWidth=18;
ctx.beginPath();
ctx.moveTo(path[0].x,path[0].y);
for(let i=1;i<path.length;i++)ctx.lineTo(path[i].x,path[i].y);
ctx.stroke();
}

function drawWorld(){
ctx.fillStyle="white";
ctx.font="40px Arial";
ctx.fillText("WORLD MAP",330,100);
ctx.fillRect(220,200,120,60);
ctx.fillRect(420,200,120,60);
ctx.fillRect(620,200,120,60);
ctx.fillStyle="black";
ctx.fillText("1",260,245);
ctx.fillText("2",460,245);
ctx.fillText("3",660,245);
}

function drawShop(){
ctx.fillStyle="white";
ctx.font="32px Arial";
ctx.fillText("SHOP",400,80);
ctx.font="20px Arial";
ctx.fillText("Damage + (150)",200,160);
ctx.fillText("Range + (150)",200,260);
ctx.fillText("Income + (150)",200,360);
ctx.fillText("Back",750,50);
}

// ---------- LOOP ----------
function loop(){
ctx.fillStyle=themes[level]?.bg||"#222";
ctx.fillRect(0,0,900,500);

if(state==="world"){
drawWorld();
requestAnimationFrame(loop);
return;
}

if(state==="shop"){
drawShop();
requestAnimationFrame(loop);
return;
}

drawPath();
spawn();

for(let i=enemies.length-1;i>=0;i--){
let e=enemies[i];
e.move();
e.draw();
if(e.i>=path.length-1){
lives--;
enemies.splice(i,1);
}
else if(e.hp<=0){
money+=20+shop.income*5;
enemies.splice(i,1);
}
}

for(let t of towers){
t.shoot();
t.draw();
}

for(let i=projectiles.length-1;i>=0;i--){
if(projectiles[i].move()){
projectiles.splice(i,1);
}else{
projectiles[i].draw();
}
}

for(let i=particles.length-1;i>=0;i--){
let p=particles[i];
ctx.fillStyle=p.color;
ctx.fillRect(p.x,p.y,3,3);
p.x+=p.vx;
p.y+=p.vy;
p.life--;
if(p.life<=0)particles.splice(i,1);
}

ctx.fillStyle="white";
ctx.fillText("Money: "+money,10,20);
ctx.fillText("Wave: "+wave,10,40);

if(wave>3){
state="shop";
}

requestAnimationFrame(loop);
}

loop();
</script>

</body>
</html>
